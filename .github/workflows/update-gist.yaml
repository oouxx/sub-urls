name: Update Gist with Remote Data

on:
  schedule:
    - cron: "0 */6 * * *"   # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘

jobs:
  update-gist:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch data from URL list
        env:
          URLS: ${{ vars.URLS }}
        run: |
          rm -f data.txt
          for url in $URLS; do
            echo ">>> Fetching: $url"
            resp=$(curl -sL "$url")
            echo "$resp" | head -n 20 
            echo "$resp" >> data.txt
            echo "" >> data.txt
          done
          echo "=== æ‹¼æ¥åçš„æ–‡ä»¶é¢„è§ˆ ==="
          head -n 20 data.txt

      - name: Update Gist
        env:
          GIST_ID: 5e7582498cbfb728fbcd3c07baa7f136   # ğŸ‘‰ æ›¿æ¢æˆä½ çš„ Gist ID
          GITHUB_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          # ç”Ÿæˆ JSON-safe çš„å†…å®¹
          CONTENT=$(jq -Rs . < data.txt)

          # ç›´æ¥ç”¨ jq æ„é€ å®Œæ•´ JSON
          JSON=$(jq -n --arg fileContent "$(<data.txt)" \
                       '{"files": {"gistfile1.txt": {"content": $fileContent}}}')

          echo "=== JSON Payload Preview ==="
          echo "$JSON" | jq .

          curl -s -X PATCH \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/gists/$GIST_ID \
            -d "$JSON"
